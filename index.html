<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Couples Meal - Premium Food Products</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #e91e63;
            --primary-light: #ff6090;
            --primary-dark: #b0003a;
            --secondary: #ff9800;
            --secondary-light: #ffc947;
            --secondary-dark: #c66900;
            --dark: #2d2d2d;
            --light: #f8f8f8;
            --success: #4caf50;
            --error: #f44336;
            --info: #2196f3;
            --text-color: #333;
            --gray-light: #f5f5f5;
            --gray: #e0e0e0;
            --gray-dark: #9e9e9e;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-hover: 0 8px 24px rgba(0,0,0,0.12);
            --radius: 12px;
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 0;
        }

        /* --- Navigation Bar --- */
        .navbar {
            background: white;
            color: var(--dark);
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .store-logo {
            height: 40px;
            width: auto;
            object-fit: contain;
        }
        .navbar h1 {
            font-size: 1.8rem;
            color: var(--primary);
            padding: 10px 0;
            font-family: 'Playfair Display', serif;
            font-weight: 600;
        }
        .nav-links {
            display: flex;
            align-items: center;
        }
        .nav-links button {
            background: none;
            border: none;
            color: var(--dark);
            padding: 15px 20px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1rem;
            font-weight: 500;
            position: relative;
        }
        .nav-links button:hover, .nav-links button.active {
            color: var(--primary);
        }
        .nav-links button::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background: var(--primary);
            transition: var(--transition);
            transform: translateX(-50%);
        }
        .nav-links button.active::after, .nav-links button:hover::after {
            width: 80%;
        }
        .cart-icon {
            display: flex;
            align-items: center;
            position: relative;
            cursor: pointer;
            padding: 15px 10px;
            color: var(--dark);
            transition: var(--transition);
            font-weight: 500;
        }
        .cart-icon:hover {
            color: var(--primary);
        }
        .cart-count {
            background: var(--primary);
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.8rem;
            position: absolute;
            top: 5px;
            right: 0;
            font-weight: 600;
        }

        /* --- View Management --- */
        .app-view {
            display: none;
            padding: 30px 0;
            animation: fadeIn 0.5s ease;
        }
        .app-view.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Home/Hero --- */
        #home-view .hero {
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1504674900247-0877df9cc836?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80') no-repeat center center/cover;
            height: 70vh;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            color: white;
            border-radius: var(--radius);
            margin-bottom: 50px;
            position: relative;
            overflow: hidden;
        }
        .hero h1 { 
            font-size: 3.5rem; 
            margin-bottom: 0.5rem; 
            font-family: 'Playfair Display', serif;
            font-weight: 600;
        }
        .hero p { 
            font-size: 1.3rem; 
            margin-bottom: 2rem; 
            max-width: 600px;
            font-weight: 300;
        }
        
        /* --- Products Grid --- */
        .view-title {
            text-align: center;
            color: var(--dark);
            margin-bottom: 40px;
            font-size: 2.5rem;
            font-family: 'Playfair Display', serif;
            font-weight: 600;
            position: relative;
            padding-bottom: 15px;
        }
        .view-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background: var(--primary);
        }

        .section-subtitle {
            text-align: center;
            color: var(--gray-dark);
            margin-bottom: 40px;
            font-size: 1.1rem;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        #products-container, #featured-products-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 30px;
        }

        .product-card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            text-align: center;
            transition: var(--transition);
            position: relative;
        }
        .product-card:hover { 
            transform: translateY(-10px); 
            box-shadow: var(--shadow-hover);
        }
        .product-image { 
            width: 100%; 
            height: 200px; 
            object-fit: cover; 
            transition: var(--transition);
        }
        .product-card:hover .product-image {
            transform: scale(1.05);
        }
        .product-name { 
            color: var(--dark); 
            margin: 20px 15px 10px; 
            font-size: 1.2rem;
            font-weight: 600;
        }
        .product-description { 
            color: #666; 
            padding: 0 15px; 
            font-size: 0.9rem; 
            margin-bottom: 15px; 
            min-height: 40px;
        }
        .product-price { 
            font-size: 1.5rem; 
            color: var(--primary); 
            font-weight: bold; 
            margin-bottom: 20px; 
        }
        
        .product-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            padding: 0 15px 20px;
        }
        
        /* --- Buttons & Forms --- */
        .btn-base {
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            border-radius: 50px;
            transition: var(--transition);
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.95rem;
            flex: 1;
        }
        .btn-primary {
            background: var(--primary); 
            color: white;
        }
        .btn-primary:hover { 
            background: var(--primary-dark); 
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(233, 30, 99, 0.3);
        }
        .btn-secondary { 
            background: var(--secondary); 
            color: white; 
        }
        .btn-secondary:hover { 
            background: var(--secondary-dark); 
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(255, 152, 0, 0.3);
        }
        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        .btn-outline:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }
        .btn-danger { 
            background: var(--error); 
            color: white; 
        }
        .btn-danger:hover { 
            background: #d32f2f; 
            transform: translateY(-2px);
        }

        .form-group { 
            margin-bottom: 20px; 
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--gray);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(233, 30, 99, 0.1);
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .auth-form {
            max-width: 400px;
            margin: 20px auto;
            padding: 30px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        /* Image Upload Styles */
        .image-upload-container {
            margin-bottom: 20px;
        }
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 8px;
            display: none;
        }
        .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        .upload-btn-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .upload-btn {
            border: 2px dashed var(--gray);
            color: var(--gray-dark);
            background-color: var(--gray-light);
            padding: 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            text-align: center;
            width: 100%;
            cursor: pointer;
            transition: var(--transition);
        }
        .upload-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        .upload-progress {
            width: 100%;
            height: 10px;
            background-color: var(--gray-light);
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
            display: none;
        }
        .upload-progress-bar {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* --- Checkout & Cart --- */
        #cart-items-container {
            padding: 20px;
            border: 1px solid var(--gray);
            border-radius: var(--radius);
            margin-bottom: 30px;
            max-width: 700px;
            margin: 0 auto 30px;
            background: white;
            box-shadow: var(--shadow);
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px dashed var(--gray);
        }
        .cart-item:last-child {
            border-bottom: none;
        }
        .cart-item-controls { 
            display: flex; 
            align-items: center; 
            gap: 10px;
        }
        .total-summary {
            text-align: right;
            font-size: 1.5rem;
            font-weight: bold;
            padding-top: 20px;
            border-top: 2px solid var(--primary);
            margin-top: 20px;
        }

        /* --- Order Confirmation View --- */
        #order-confirmation-view {
            text-align: center;
            padding: 50px 0;
        }
        .confirmation-icon {
            font-size: 4rem;
            color: var(--success);
            margin-bottom: 20px;
        }
        .confirmation-message {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        /* --- Notifications & Admin --- */
        .notification {
            padding: 12px 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            color: white;
            display: none;
            box-shadow: var(--shadow);
        }
        .notification.success { background: var(--success); }
        .notification.error { background: var(--error); }
        .notification.info { background: var(--info); }
        
        #admin-panel-toggle {
            text-align: center;
            padding: 30px 0;
        }
        #admin-panel-toggle a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        #admin-panel-toggle a:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }
        #adminPanel {
            background: white;
            padding: 30px;
            margin-top: 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: var(--shadow);
            border-radius: 8px;
            overflow: hidden;
        }
        .admin-table th, .admin-table td {
            border: 1px solid var(--gray);
            padding: 12px 15px;
            text-align: left;
        }
        .admin-table th {
            background: var(--gray-light);
            font-weight: 600;
        }
        .admin-table tr:nth-child(even) {
            background: var(--gray-light);
        }
        
        /* Tabbed Interface */
        .tabs { 
            display: flex; 
            border-bottom: 2px solid var(--gray); 
            margin-bottom: 20px; 
        }
        .tab-button { 
            background: var(--gray-light); 
            border: none; 
            padding: 12px 20px; 
            cursor: pointer; 
            transition: var(--transition); 
            margin-right: 5px; 
            border-radius: 8px 8px 0 0; 
            font-weight: 600; 
        }
        .tab-button.active { 
            background: white; 
            border: 1px solid var(--gray); 
            border-bottom: 2px solid white; 
            color: var(--primary); 
        }
        .tab-content { 
            background: white; 
            padding: 25px; 
            border-radius: 0 0 var(--radius) var(--radius); 
            box-shadow: var(--shadow); 
            min-height: 400px; 
        }
        .tab-pane { 
            display: none; 
        }
        .tab-pane.active { 
            display: block; 
        }
        .order-status { 
            font-weight: bold; 
            padding: 5px 10px; 
            border-radius: 20px; 
            font-size: 0.8em; 
            display: inline-block;
        }
        .status-new { background-color: var(--info); color: white; }
        .status-processing { background-color: var(--secondary); color: white; }
        .status-shipped { background-color: var(--success); color: white; }
        .status-cancelled { background-color: var(--error); color: white; }

        /* Admin Instructions */
        .admin-instructions {
            background: #f0f7ff;
            border-left: 4px solid var(--info);
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .admin-instructions h4 {
            color: var(--info);
            margin-bottom: 10px;
        }
        .admin-instructions ul {
            padding-left: 20px;
        }
        .admin-instructions li {
            margin-bottom: 8px;
        }

        /* Footer */
        footer {
            background: var(--dark);
            color: white;
            padding: 40px 0;
            margin-top: 60px;
        }
        footer .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        footer .footer-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        footer .footer-links {
            display: flex;
            gap: 20px;
        }
        footer .footer-links a {
            color: white;
            text-decoration: none;
            transition: var(--transition);
        }
        footer .footer-links a:hover {
            color: var(--primary-light);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                padding: 15px;
            }
            .nav-links {
                width: 100%;
                justify-content: center;
                margin-top: 10px;
            }
            .hero h1 {
                font-size: 2.5rem;
            }
            .hero p {
                font-size: 1.1rem;
            }
            footer .container {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            .cart-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .cart-item-controls {
                align-self: flex-end;
            }
            .product-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    
    <nav class="navbar">
        <div class="navbar-brand">
            <img id="storeLogo" src="" alt="Store Logo" class="store-logo" style="display: none;">
            <h1 id="headerStoreName">Couples Meal</h1>
        </div>
        <div class="nav-links">
            <button data-view="home" class="nav-btn active">Home</button>
            <button data-view="products" class="nav-btn">Products</button>
            <button data-view="checkout" class="nav-btn">Checkout</button>
            <button data-view="myaccount" class="nav-btn">My Account</button>
            <div class="cart-icon" onclick="navigateTo('checkout')">
                <span>🛒</span> Cart <span id="cart-count" class="cart-count">0</span>
            </div>
        </div>
    </nav>

    <div id="app-view-container" class="container">

        <section id="home-view" class="app-view active">
            <div class="hero">
                <h1>Gourmet Meals, Delivered</h1>
                <p>Premium food products perfectly crafted for two. Experience restaurant-quality dining in the comfort of your home.</p>
                <button class="btn-primary btn-base" onclick="navigateTo('products')">
                    <span>Shop Our Menu</span>
                    <span>→</span>
                </button>
            </div>
            
            <h2 class="view-title">Featured Products</h2>
            <p class="section-subtitle">Our most popular gourmet meals, carefully crafted for unforgettable dining experiences.</p>
            <div id="featured-products-container" class="products-grid">
                <!-- Featured products will be loaded here -->
            </div>
        </section>

        <section id="products-view" class="app-view">
            <h2 class="view-title">Our Full Menu</h2>
            <p class="section-subtitle">Explore our complete selection of premium meals designed for couples.</p>
            <div id="products-container">
                <p style="text-align: center;">Loading delicious products...</p>
            </div>
        </section>

        <section id="checkout-view" class="app-view">
            <h2 class="view-title">Your Order</h2>
            <div id="checkoutNotification" class="notification customer"></div>
            
            <div id="cart-items-container">
                <!-- Cart items will be loaded here -->
            </div>

            <div id="checkout-form-container" style="max-width: 700px; margin: 0 auto;">
                <div style="background: white; padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow);">
                    <p class="total-summary">Total: <span id="cart-total">$0.00</span></p>

                    <h3 style="margin-top: 30px; margin-bottom: 20px; color: var(--dark);">Shipping & Contact Info</h3>
                    <form id="checkoutForm">
                        <div class="form-group">
                            <label for="customerName">Full Name *</label>
                            <input type="text" id="customerName" placeholder="Enter your full name" required>
                        </div>
                        <div class="form-group">
                            <label for="customerPhone">Phone Number *</label>
                            <input type="tel" id="customerPhone" placeholder="Enter your phone number" required>
                        </div>
                        <div class="form-group">
                            <label for="customerAddress">Shipping Address *</label>
                            <input type="text" id="customerAddress" placeholder="Enter your complete shipping address" required>
                        </div>
                        <div class="form-group">
                            <label for="customerNote">Special Notes</label>
                            <textarea id="customerNote" placeholder="Any special delivery instructions or notes"></textarea>
                        </div>
                        <button type="submit" class="btn-primary btn-base" style="width: 100%; padding: 15px;">
                            <span>Place Order</span>
                            <span>✓</span>
                        </button>
                    </form>
                </div>
            </div>
        </section>

        <section id="order-confirmation-view" class="app-view">
            <div class="confirmation-message">
                <div class="confirmation-icon">✓</div>
                <h2 class="view-title">Order Confirmed!</h2>
                <p style="margin-bottom: 20px;">Thank you for your order. We'll start preparing your meal right away.</p>
                <p style="margin-bottom: 30px; color: var(--gray-dark);">You will receive a confirmation email shortly with your order details.</p>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn-primary btn-base" onclick="navigateTo('home')">
                        <span>Back to Home</span>
                    </button>
                    <button class="btn-outline btn-base" onclick="navigateTo('products')">
                        <span>Continue Shopping</span>
                    </button>
                </div>
            </div>
        </section>

        <section id="myaccount-view" class="app-view">
            <h2 class="view-title">My Account</h2>
            <div id="accountContent">
                <div id="accountStatus" style="text-align: center; margin-bottom: 30px;">
                    <p>You are currently not logged in.</p>
                </div>
                
                <div id="authForms" class="auth-form">
                    <h3 style="text-align: center; margin-bottom: 20px; color: var(--dark);">Customer Login / Sign Up</h3>
                    <div id="accountNotification" class="notification customer"></div>
                    <form id="customerLoginForm">
                        <div class="form-group">
                            <input type="email" id="customerEmailAuth" placeholder="Email" required>
                        </div>
                        <div class="form-group">
                            <input type="password" id="customerPasswordAuth" placeholder="Password" required>
                        </div>
                        <button type="submit" class="btn-primary btn-base" style="width: 100%;">Login</button>
                        <button type="button" class="btn-outline btn-base" id="signUpBtn" style="width: 100%; margin-top: 10px;">Sign Up</button>
                    </form>
                </div>
                
                <div id="orderHistory" style="display: none; max-width: 700px; margin: 0 auto;">
                    <div style="background: white; padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow);">
                        <h4 style="margin-bottom: 20px; color: var(--dark);">My Recent Orders</h4>
                        <div id="historyList">
                            <p>Loading orders...</p>
                        </div>
                        <button class="btn-danger btn-base" style="margin-top: 20px;" onclick="auth.signOut()">Logout</button>
                    </div>
                </div>
            </div>
        </section>
        
        <div id="admin-panel-toggle">
            <a href="javascript:void(0)" onclick="toggleAdminPanel()">
                <span>⚙️</span>
                <span>Admin Access</span>
            </a>
        </div>

        <div id="admin-access-area" style="display: none;">
            <section id="admin" class="container">
                <div id="loginSection" class="auth-form" style="margin: 0 auto 30px;">
                    <h3 style="text-align: center; margin-bottom: 20px; color: var(--dark);">Admin Login</h3>
                    
                    <div class="admin-instructions">
                        <h4>How to access the Admin Panel:</h4>
                        <ul>
                            <li>Use an email that contains "admin" (e.g., admin@couplesmeal.com)</li>
                            <li>If you don't have an admin account, create one in the "My Account" section first</li>
                            <li>After creating an account with an admin email, use it to log in here</li>
                        </ul>
                    </div>
                    
                    <p id="authStatus" style="text-align: center; padding: 10px; background: var(--gray-light); border-radius: 8px;">Logged Out</p>
                    <form id="adminLoginForm">
                        <div class="form-group">
                            <input type="email" id="loginEmail" placeholder="Email" required>
                        </div>
                        <div class="form-group">
                            <input type="password" id="loginPassword" placeholder="Password" required>
                        </div>
                        <button type="submit" class="btn-primary btn-base" style="width: 100%;">Login to Admin</button>
                    </form>
                </div>

                <div id="adminPanel" style="display: none;">
                    <div class="tabs">
                        <button class="tab-button active" data-tab="products">Products</button>
                        <button class="tab-button" data-tab="orders">Orders</button>
                        <button class="tab-button" data-tab="settings">Settings</button>
                    </div>
                    
                    <div class="tab-content">
                        <div id="products-pane" class="tab-pane active">
                            <div id="productNotification" class="notification"></div>
                            
                            <h3 style="margin-bottom: 20px; color: var(--dark);">Product Management</h3>
                            <button id="showAddProductForm" class="btn-secondary btn-base" style="margin-bottom: 20px;">
                                <span>+</span>
                                <span>Add New Product</span>
                            </button>
                            
                            <div id="addProductContainer" style="display:none; padding: 25px; background: var(--gray-light); border-radius: var(--radius); margin-bottom: 25px;">
                                <h4 style="margin-bottom: 15px; color: var(--dark);"><span id="productFormTitle">Add New Product</span></h4>
                                <form id="saveProductForm">
                                    <input type="hidden" id="productIdToEdit">
                                    <div class="form-group">
                                        <label for="productName">Name</label>
                                        <input type="text" id="productName" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="productDesc">Description</label>
                                        <textarea id="productDesc" rows="3" required></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="productPrice">Price ($)</label>
                                        <input type="number" id="productPrice" step="0.01" required>
                                    </div>
                                    
                                    <!-- Image Upload Section -->
                                    <div class="form-group">
                                        <label for="productImageUpload">Product Image</label>
                                        <div class="image-upload-container">
                                            <div class="upload-btn-wrapper">
                                                <div class="upload-btn">
                                                    <span id="upload-btn-text">Click to upload an image or drag & drop</span>
                                                    <input type="file" id="productImageUpload" accept="image/*">
                                                </div>
                                            </div>
                                            <div class="upload-progress" id="uploadProgress">
                                                <div class="upload-progress-bar" id="uploadProgressBar"></div>
                                            </div>
                                            <img id="imagePreview" class="image-preview" src="" alt="Image Preview">
                                        </div>
                                        <small style="color: var(--gray-dark);">Upload an image or provide a URL below</small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="productImage">Or use Image URL</label>
                                        <input type="url" id="productImage" placeholder="https://example.com/image.jpg">
                                    </div>
                                    
                                    <div style="display: flex; gap: 10px;">
                                        <button type="submit" class="btn-primary btn-base">
                                            <span id="productSubmitButtonText">Save Product</span>
                                            <span>✓</span>
                                        </button>
                                        <button type="button" class="btn-outline btn-base" id="cancelEdit">Cancel</button>
                                    </div>
                                </form>
                            </div>
                            
                            <table class="admin-table">
                                <thead>
                                    <tr><th>Name</th><th>Price</th><th>Image</th><th>Date Created</th><th>Actions</th></tr>
                                </thead>
                                <tbody id="adminProductsTableBody">
                                    <tr><td colspan="5">Loading products...</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div id="orders-pane" class="tab-pane">
                            <h3 style="margin-bottom: 20px; color: var(--dark);">Order Management</h3>
                            <div id="orderNotification" class="notification"></div>
                            <table class="admin-table">
                                <thead>
                                    <tr><th>Order ID</th><th>Customer Name</th><th>Phone</th><th>Date</th><th>Total</th><th>Status</th><th>Actions</th></tr>
                                </thead>
                                <tbody id="ordersTableBody">
                                    <tr><td colspan="7">Loading orders...</td></tr>
                                </tbody>
                            </table>

                            <div id="invoice-print-area" style="display:none;"></div>
                        </div>

                        <div id="settings-pane" class="tab-pane">
                            <div id="settingsNotification" class="notification"></div>
                            <h3 style="margin-bottom: 20px; color: var(--dark);">Store Settings</h3>
                            <form id="storeSettingsForm">
                                <fieldset style="border: 1px solid var(--gray); padding: 20px; border-radius: var(--radius);">
                                    <legend style="padding: 0 10px; font-weight: 600;">Store Details</legend>
                                    <div class="form-group">
                                        <label for="storeName">Store Name</label>
                                        <input type="text" id="storeName" value="Couples Meal" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="storeTitle">Page Title</label>
                                        <input type="text" id="storeTitle" value="Couples Meal - Premium Food Products" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="storeLogoUrl">Logo URL</label>
                                        <input type="url" id="storeLogoUrl" placeholder="https://example.com/logo.png">
                                        <small style="color: var(--gray-dark);">Enter a URL for your store logo. Recommended size: 40px height.</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="storeAddress">Address</label>
                                        <input type="text" id="storeAddress" value="123 Gourmet Lane, Food City, CA 90210">
                                    </div>
                                    <div class="form-group">
                                        <label for="storeContact">Contact Email</label>
                                        <input type="email" id="storeContact" value="support@couplesmeal.com" required>
                                    </div>
                                </fieldset>
                                <button type="submit" class="btn-primary btn-base" style="margin-top: 20px;">
                                    <span>Save Settings</span>
                                    <span>✓</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </section>
        </div>

    </div>
    
    <footer>
        <div class="container">
            <div class="footer-info">
                <p>&copy; <span id="footerYear">2025</span> <span id="footerStoreName">Couples Meal</span>. All rights reserved.</p>
                <p style="color: var(--gray-dark); font-size: 0.9rem;">Premium food products for couples</p>
            </div>
            <div class="footer-links">
                <a href="javascript:void(0)" onclick="navigateTo('home')">Home</a>
                <a href="javascript:void(0)" onclick="navigateTo('products')">Products</a>
                <a href="javascript:void(0)" onclick="toggleAdminPanel()">Admin</a>
            </div>
        </div>
    </footer>
    
    <script>
        // *** FIREBASE CONFIGURATION ***
        const firebaseConfig = {
            apiKey: "AIzaSyCgqhmrtwkpXQA96PE7lUWb-_91RHAHK9U",
            authDomain: "couples-meal.firebaseapp.com",
            projectId: "couples-meal",
            storageBucket: "couples-meal.firebasestorage.app",
            messagingSenderId: "1002917314321",
            appId: "1:1002917314321:web:351456c76c2d66943496b0",
            measurementId: "G-HD2EG8GSG7"
        };
        
        // GLOBAL REFERENCES & STATE
        let db;
        let auth;
        let storage;
        let productsCache = {};
        let cart = [];
        let currentView = 'home';
        
        const COLLECTIONS = {
            PRODUCTS: 'products',
            ORDERS: 'orders',
            SETTINGS: 'settings'
        };

        // Utility to show temporary notifications
        function showNotification(message, isError = false, targetId = 'productNotification') {
            const notification = document.getElementById(targetId);
            if (!notification) return;

            notification.textContent = message;
            notification.className = 'notification ' + (isError ? 'error' : 'success') + (targetId.includes('customer') ? ' customer' : '');
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }

        // --- IMAGE UPLOAD FUNCTIONALITY ---
        
        // Initialize image upload functionality
        function initializeImageUpload() {
            const fileInput = document.getElementById('productImageUpload');
            const imagePreview = document.getElementById('imagePreview');
            const uploadProgress = document.getElementById('uploadProgress');
            const uploadProgressBar = document.getElementById('uploadProgressBar');
            const uploadBtnText = document.getElementById('upload-btn-text');
            
            // Handle file selection
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validate file type
                    if (!file.type.match('image.*')) {
                        showNotification('Please select an image file (JPEG, PNG, etc.)', true);
                        return;
                    }
                    
                    // Validate file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        showNotification('Image size should be less than 5MB', true);
                        return;
                    }
                    
                    // Show preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.src = e.target.result;
                        imagePreview.style.display = 'block';
                        uploadBtnText.textContent = 'Change Image';
                    };
                    reader.readAsDataURL(file);
                    
                    // Upload to Firebase Storage
                    uploadImageToStorage(file);
                }
            });
            
            // Handle drag and drop
            const uploadBtn = document.querySelector('.upload-btn');
            uploadBtn.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadBtn.style.borderColor = 'var(--primary)';
                uploadBtn.style.color = 'var(--primary)';
            });
            
            uploadBtn.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadBtn.style.borderColor = 'var(--gray)';
                uploadBtn.style.color = 'var(--gray-dark)';
            });
            
            uploadBtn.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadBtn.style.borderColor = 'var(--gray)';
                uploadBtn.style.color = 'var(--gray-dark)';
                
                const file = e.dataTransfer.files[0];
                if (file) {
                    fileInput.files = e.dataTransfer.files;
                    const event = new Event('change');
                    fileInput.dispatchEvent(event);
                }
            });
        }
        
        // Upload image to Firebase Storage
        function uploadImageToStorage(file) {
            const uploadProgress = document.getElementById('uploadProgress');
            const uploadProgressBar = document.getElementById('uploadProgressBar');
            const productImageInput = document.getElementById('productImage');
            
            // Show progress bar
            uploadProgress.style.display = 'block';
            uploadProgressBar.style.width = '0%';
            
            // Create a storage reference
            const storageRef = storage.ref();
            const imageRef = storageRef.child('product-images/' + Date.now() + '-' + file.name);
            
            // Upload file
            const uploadTask = imageRef.put(file);
            
            // Monitor upload progress
            uploadTask.on('state_changed',
                function(snapshot) {
                    // Progress monitoring
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    uploadProgressBar.style.width = progress + '%';
                },
                function(error) {
                    // Handle errors
                    console.error('Upload failed:', error);
                    showNotification('Image upload failed: ' + error.message, true);
                    uploadProgress.style.display = 'none';
                },
                function() {
                    // Upload completed successfully
                    uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {
                        // Set the download URL in the image URL field
                        productImageInput.value = downloadURL;
                        showNotification('Image uploaded successfully!', false);
                        uploadProgress.style.display = 'none';
                    });
                }
            );
        }

        // --- NAVIGATION AND VIEW MANAGEMENT ---
        window.navigateTo = function(viewName) {
            currentView = viewName;
            
            document.querySelectorAll('.app-view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(`${viewName}-view`).classList.add('active');

            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.nav-btn[data-view="${viewName}"]`)?.classList.add('active');
            
            // Special view rendering logic
            if (viewName === 'checkout') {
                renderCart();
            } else if (viewName === 'myaccount') {
                renderMyAccount();
            }
        }
        
        window.toggleAdminPanel = function() {
            const adminArea = document.getElementById('admin-access-area');
            adminArea.style.display = adminArea.style.display === 'none' ? 'block' : 'none';
            if (adminArea.style.display === 'block') {
                window.scrollTo(0, document.body.scrollHeight);
            }
        }

        function setActiveAdminTab(tabName) {
            document.querySelectorAll('#adminPanel .tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`#adminPanel .tab-button[data-tab="${tabName}"]`).classList.add('active');
            
            document.querySelectorAll('#adminPanel .tab-pane').forEach(pane => pane.classList.remove('active'));
            document.getElementById(`${tabName}-pane`).classList.add('active');
        }

        // --- CART & CHECKOUT FUNCTIONS ---
        window.addToCart = function(productId) {
            const product = productsCache[productId];
            if (!product) {
                showNotification('Product not found.', true, 'checkoutNotification');
                return;
            }

            const existingItem = cart.find(item => item.id === productId);

            if (existingItem) {
                existingItem.qty += 1;
            } else {
                cart.push({
                    id: productId,
                    name: product.name,
                    price: product.price,
                    qty: 1
                });
            }
            showNotification(`${product.name} added to cart!`, false, 'checkoutNotification');
            updateCartCount();
        }

        window.addToCartAndCheckout = function(productId) {
            const product = productsCache[productId];
            if (!product) {
                showNotification('Product not found.', true, 'checkoutNotification');
                return;
            }

            const existingItem = cart.find(item => item.id === productId);

            if (existingItem) {
                existingItem.qty += 1;
            } else {
                cart.push({
                    id: productId,
                    name: product.name,
                    price: product.price,
                    qty: 1
                });
            }
            showNotification(`${product.name} added to cart!`, false, 'checkoutNotification');
            updateCartCount();
            navigateTo('checkout');
        }

        function updateCartCount() {
            const count = cart.reduce((total, item) => total + item.qty, 0);
            document.getElementById('cart-count').textContent = count;
        }

        function calculateCartTotal() {
            return cart.reduce((total, item) => total + (item.price * item.qty), 0);
        }

        function renderCart() {
            const container = document.getElementById('cart-items-container');
            const totalSpan = document.getElementById('cart-total');
            container.innerHTML = '';
            document.getElementById('checkoutNotification').style.display = 'none';

            if (cart.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 30px;"><p style="margin-bottom: 20px;">Your cart is empty.</p><button class="btn-secondary btn-base" onclick="navigateTo(\'products\')">Go Shopping</button></div>';
                totalSpan.textContent = '$0.00';
                document.getElementById('checkoutForm').style.display = 'none';
                return;
            }

            document.getElementById('checkoutForm').style.display = 'block';
            
            cart.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('cart-item');
                itemDiv.innerHTML = `
                    <div class="cart-item-info">
                        <strong>${item.name}</strong> ($${item.price.toFixed(2)} ea.)
                    </div>
                    <div class="cart-item-controls">
                        <button class="btn-outline btn-base" style="padding: 5px 10px;" onclick="updateCartItemQty('${item.id}', -1)">-</button>
                        <span style="margin: 0 10px; font-weight: 600;">${item.qty}</span>
                        <button class="btn-outline btn-base" style="padding: 5px 10px;" onclick="updateCartItemQty('${item.id}', 1)">+</button>
                        <button class="btn-danger btn-base" style="padding: 5px 10px;" onclick="updateCartItemQty('${item.id}', 0)">Remove</button>
                    </div>
                `;
                container.appendChild(itemDiv);
            });

            const total = calculateCartTotal();
            totalSpan.textContent = `$${total.toFixed(2)}`;
            updateCartCount();
        }

        window.updateCartItemQty = function(productId, delta) {
            const itemIndex = cart.findIndex(item => item.id === productId);
            if (itemIndex > -1) {
                const item = cart[itemIndex];
                
                if (delta === 0 || item.qty + delta <= 0) {
                    // Remove item
                    cart.splice(itemIndex, 1);
                } else {
                    // Update quantity
                    item.qty += delta;
                }
                renderCart();
            }
        }
        
        window.placeOrder = async function(e) {
            e.preventDefault();
            if (cart.length === 0) {
                showNotification('Your cart is empty!', true, 'checkoutNotification');
                return;
            }
            
            const name = document.getElementById('customerName').value;
            const phone = document.getElementById('customerPhone').value;
            const address = document.getElementById('customerAddress').value;
            const note = document.getElementById('customerNote').value;
            const total = calculateCartTotal();
            
            const orderData = {
                customerName: name,
                customerPhone: phone,
                customerAddress: address,
                customerNote: note,
                items: cart.map(item => ({ id: item.id, name: item.name, price: item.price, qty: item.qty })),
                total: total,
                status: 'new',
                userId: auth.currentUser ? auth.currentUser.uid : 'guest',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection(COLLECTIONS.ORDERS).add(orderData);
                // Clear cart and redirect to order confirmation
                cart = [];
                updateCartCount();
                navigateTo('order-confirmation');
            } catch (error) {
                console.error("Error placing order:", error);
                showNotification(`Order failed: ${error.message}. Check database write rules.`, true, 'checkoutNotification');
            }
        }

        // --- MY ACCOUNT FUNCTIONS ---
        function renderMyAccount() {
            const user = auth.currentUser;
            const accountStatus = document.getElementById('accountStatus');
            const authForms = document.getElementById('authForms');
            const orderHistory = document.getElementById('orderHistory');
            
            if (user) {
                accountStatus.innerHTML = `<p>Welcome, <strong>${user.email}</strong>! You can view your order history below.</p>`;
                authForms.style.display = 'none';
                orderHistory.style.display = 'block';
                fetchOrderHistory(user.uid);
            } else {
                accountStatus.innerHTML = `<p>You are currently not logged in.</p>`;
                authForms.style.display = 'block';
                orderHistory.style.display = 'none';
                document.getElementById('historyList').innerHTML = '<p>Login to view your order history.</p>';
            }
        }

        function fetchOrderHistory(userId) {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '<p>Loading order history...</p>';

            db.collection(COLLECTIONS.ORDERS)
                .where('userId', '==', userId)
                .orderBy('createdAt', 'desc')
                .get()
                .then(snapshot => {
                    historyList.innerHTML = '';
                    if (snapshot.empty) {
                        historyList.innerHTML = '<p>No previous orders found.</p>';
                        return;
                    }

                    snapshot.forEach(doc => {
                        const order = doc.data();
                        const date = order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleString() : 'N/A';
                        const firstItem = order.items[0]?.name || 'N/A';
                        
                        historyList.innerHTML += `
                            <div class="history-item" style="padding: 15px; border-bottom: 1px solid var(--gray);">
                                <strong>Order ID: ${doc.id.substring(0, 8)}...</strong>
                                <div class="history-item-details" style="margin-top: 8px;">
                                    Date: ${date} | Total: $${order.total.toFixed(2)} | Status: <span class="order-status status-${order.status}">${order.status.toUpperCase()}</span>
                                    <br>
                                    Items: ${firstItem} and ${order.items.length - 1} more items.
                                </div>
                            </div>
                        `;
                    });
                })
                .catch(error => {
                    console.error("Error fetching order history:", error);
                    historyList.innerHTML = `<p style="color: var(--error);">Error loading history: ${error.message}</p>`;
                });
        }

        // --- STOREFRONT (PRODUCTS) FUNCTIONS ---
        function renderProductCard(product, productId, container) {
            const card = document.createElement('div');
            card.classList.add('product-card');
            const formattedPrice = product.price ? parseFloat(product.price).toFixed(2) : 'N/A';
            
            // Cache the product data
            productsCache[productId] = { id: productId, ...product };
            
            card.innerHTML = `
                <img src="${product.imageUrl || 'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80'}" alt="${product.name}" class="product-image" onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1546069901-ba9599a7e63c?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80';">
                <div style="padding: 20px;">
                    <h3 class="product-name">${product.name}</h3>
                    <p class="product-description">${product.description || 'A delicious, premium meal for two.'}</p>
                    <div class="product-price">$${formattedPrice}</div>
                    <div class="product-actions">
                        <button class="btn-outline btn-base" data-id="${productId}" onclick="addToCart('${productId}')">
                            <span>Add to Cart</span>
                            <span>+</span>
                        </button>
                        <button class="btn-primary btn-base" data-id="${productId}" onclick="addToCartAndCheckout('${productId}')">
                            <span>Order Now</span>
                            <span>→</span>
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(card);
        }

        function fetchAndRenderProducts(db) {
            const productsContainer = document.getElementById('products-container');
            const featuredContainer = document.getElementById('featured-products-container');
            if (!productsContainer) return;

            productsContainer.innerHTML = '<p style="text-align: center;">Loading products...</p>';
            featuredContainer.innerHTML = '';
            productsCache = {}; 

            db.collection(COLLECTIONS.PRODUCTS).get()
                .then((querySnapshot) => {
                    productsContainer.innerHTML = ''; 
                    const adminTableBody = document.getElementById('adminProductsTableBody');
                    if(adminTableBody) adminTableBody.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        const noDataMessage = 'No products found.';
                        productsContainer.innerHTML = `<p style="text-align: center;">${noDataMessage}</p>`;
                        if(adminTableBody) adminTableBody.innerHTML = `<tr><td colspan="5">${noDataMessage}</td></tr>`;
                        return;
                    }

                    querySnapshot.forEach((doc, index) => {
                        const product = doc.data();
                        const productId = doc.id;
                        
                        renderProductCard(product, productId, productsContainer);
                        
                        // Add first 3 products to the Home/Featured section
                        if (index < 3) {
                            const featuredCard = productsContainer.lastChild.cloneNode(true);
                            featuredContainer.appendChild(featuredCard);
                        }

                        if(adminTableBody && auth.currentUser) renderAdminProductRow(product, productId, adminTableBody, db);
                    });
                })
                .catch(error => {
                    console.error("Error fetching products: ", error);
                    productsContainer.innerHTML = `<p style="color: var(--error); text-align: center;">Error loading products: ${error.message}. Check your Firestore Security Rules for read access.</p>`;
                });
        }
        
        // --- ADMIN FUNCTIONS (Product CRUD, Orders, Settings) ---
        
        function renderAdminProductRow(product, productId, tableBody) {
            const row = tableBody.insertRow();
            const formattedPrice = product.price ? parseFloat(product.price).toFixed(2) : 'N/A';
            const date = product.createdAt ? new Date(product.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
            const imagePreview = product.imageUrl ? 
                `<img src="${product.imageUrl}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">` : 
                'No Image';
            
            row.innerHTML = `
                <td>${product.name}</td>
                <td>$${formattedPrice}</td>
                <td>${imagePreview}</td>
                <td>${date}</td>
                <td>
                    <button class="btn-secondary btn-base" data-id="${productId}" onclick="editProduct('${productId}')" style="padding: 5px 10px;">Edit</button>
                    <button class="btn-danger btn-base" data-id="${productId}" onclick="deleteProduct('${productId}')" style="padding: 5px 10px;">Delete</button>
                </td>
            `;
        }

        window.editProduct = function(productId) {
            db.collection(COLLECTIONS.PRODUCTS).doc(productId).get()
                .then(doc => {
                    if (doc.exists) {
                        const product = doc.data();
                        document.getElementById('productIdToEdit').value = productId;
                        document.getElementById('productName').value = product.name;
                        document.getElementById('productDesc').value = product.description;
                        document.getElementById('productPrice').value = product.price;
                        document.getElementById('productImage').value = product.imageUrl || '';
                        
                        // Reset image preview and upload
                        document.getElementById('imagePreview').style.display = 'none';
                        document.getElementById('imagePreview').src = '';
                        document.getElementById('productImageUpload').value = '';
                        document.getElementById('upload-btn-text').textContent = 'Click to upload an image or drag & drop';
                        
                        document.getElementById('productFormTitle').textContent = 'Edit Product: ' + product.name;
                        document.getElementById('productSubmitButtonText').textContent = 'Update Product';
                        document.getElementById('addProductContainer').style.display = 'block';
                        document.getElementById('showAddProductForm').style.display = 'none';
                        setActiveAdminTab('products');
                        window.scrollTo(0, document.getElementById('adminPanel').offsetTop);
                    } else {
                        showNotification('Product not found.', true);
                    }
                })
                .catch(error => showNotification(`Error loading product: ${error.message}`, true));
        }

        window.deleteProduct = function(productId) {
            if (!confirm("Are you sure you want to delete this product?")) return;
            db.collection(COLLECTIONS.PRODUCTS).doc(productId).delete()
                .then(() => {
                    showNotification('Product deleted successfully!');
                    fetchAndRenderProducts(db); 
                })
                .catch(error => showNotification(`Error deleting product: ${error.message}`, true));
        };
        
        // Admin Order Functions
        function fetchAndRenderOrders() {
            const ordersTableBody = document.getElementById('ordersTableBody');
            ordersTableBody.innerHTML = '<tr><td colspan="7">Loading orders...</td></tr>';
            
            db.collection(COLLECTIONS.ORDERS)
                .orderBy('createdAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    ordersTableBody.innerHTML = '';
                    if (querySnapshot.empty) {
                        ordersTableBody.innerHTML = `<tr><td colspan="7">No orders placed yet.</td></tr>`;
                        return;
                    }
                    querySnapshot.forEach((doc) => renderAdminOrderRow(doc.data(), doc.id, ordersTableBody));
                })
                .catch(error => {
                    ordersTableBody.innerHTML = `<tr><td colspan="7" style="color: var(--error);">Error loading orders: ${error.message}</td></tr>`;
                });
        }

        function renderAdminOrderRow(order, orderId, tableBody) {
            const row = tableBody.insertRow();
            const date = order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
            const statusClass = `status-${order.status}`;
            
            row.innerHTML = `
                <td>${orderId.substring(0, 8)}...</td>
                <td>${order.customerName}</td>
                <td>${order.customerPhone}</td>
                <td>${date}</td>
                <td>$${order.total.toFixed(2)}</td>
                <td><span class="order-status ${statusClass}">${order.status.toUpperCase()}</span></td>
                <td>
                    <button class="btn-secondary btn-base" onclick="generateInvoice('${orderId}')" style="padding: 5px 10px;">Invoice</button>
                    <select onchange="updateOrderStatus('${orderId}', this.value)" style="padding: 5px; border-radius: 4px; border: 1px solid var(--gray);">
                        <option value="${order.status}" selected>${order.status.charAt(0).toUpperCase() + order.status.slice(1)}</option>
                        <option value="new">New</option>
                        <option value="processing">Processing</option>
                        <option value="shipped">Shipped</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </td>
            `;
        }

        window.updateOrderStatus = function(orderId, newStatus) {
            db.collection(COLLECTIONS.ORDERS).doc(orderId).update({ status: newStatus })
                .then(() => {
                    showNotification(`Order ${orderId.substring(0, 8)}... status updated to ${newStatus}.`, false, 'orderNotification');
                    fetchAndRenderOrders(db);
                })
                .catch(error => showNotification(`Error updating status: ${error.message}`, true, 'orderNotification'));
        };

        window.generateInvoice = function(orderId) {
            db.collection(COLLECTIONS.ORDERS).doc(orderId).get()
                .then(doc => {
                    if (doc.exists) {
                        const order = doc.data();
                        const settings = {
                            name: document.getElementById('storeName').value,
                            address: document.getElementById('storeAddress').value,
                            contact: document.getElementById('storeContact').value
                        };
                        
                        const invoiceArea = document.getElementById('invoice-print-area');
                        let itemsHtml = order.items.map(item => `
                            <tr>
                                <td style="border: 1px solid #ccc; padding: 8px;">${item.name}</td>
                                <td style="border: 1px solid #ccc; padding: 8px;">${item.qty}</td>
                                <td style="border: 1px solid #ccc; padding: 8px;">$${item.price.toFixed(2)}</td>
                                <td style="border: 1px solid #ccc; padding: 8px;">$${(item.qty * item.price).toFixed(2)}</td>
                            </tr>
                        `).join('');

                        invoiceArea.innerHTML = `
                            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; border: 1px solid #ccc; padding: 20px;">
                                <h2 style="color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; text-align: center;">${settings.name}</h2>
                                <h3 style="text-align: center; margin-bottom: 20px;">INVOICE</h3>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 0.9em;">
                                    <div>
                                        <strong>From:</strong><br>${settings.name}<br>${settings.address}<br>${settings.contact}
                                    </div>
                                    <div>
                                        <strong>To:</strong><br>${order.customerName}<br>${order.customerPhone}<br>${order.customerAddress}
                                    </div>
                                </div>
                                <div style="margin-bottom: 20px;">
                                    <strong>Invoice #:</strong> ${orderId.substring(0, 12)}<br>
                                    <strong>Date:</strong> ${new Date(order.createdAt.seconds * 1000).toLocaleDateString()}
                                </div>
                                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                                    <thead>
                                        <tr style="background-color: #f2f2f2;">
                                            <th style="border: 1px solid #ccc; padding: 8px;">Item</th>
                                            <th style="border: 1px solid #ccc; padding: 8px;">Qty</th>
                                            <th style="border: 1px solid #ccc; padding: 8px;">Unit Price</th>
                                            <th style="border: 1px solid #ccc; padding: 8px;">Line Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>${itemsHtml}</tbody>
                                </table>
                                <div style="text-align: right; font-size: 1.2em; font-weight: bold;">
                                    Total: $${order.total.toFixed(2)}
                                </div>
                                ${order.customerNote ? `<div style="margin-top: 20px; padding: 10px; background: #f9f9f9; border-radius: 5px;"><strong>Special Note:</strong> ${order.customerNote}</div>` : ''}
                                <p style="text-align: center; margin-top: 30px; font-size: 0.8em; color: #888;">Thank you for your business!</p>
                            </div>
                        `;
                        window.print();
                    } else {
                        showNotification('Order not found for invoice.', true, 'orderNotification');
                    }
                })
                .catch(error => showNotification(`Error generating invoice: ${error.message}`, true, 'orderNotification'));
        };

        function fetchAndRenderSettings() {
            db.collection(COLLECTIONS.SETTINGS).doc('store').get()
                .then(doc => {
                    const settings = doc.exists ? doc.data() : { 
                        name: "Couples Meal", 
                        title: "Couples Meal - Premium Food Products", 
                        address: "123 Gourmet Lane, Food City, CA 90210", 
                        contact: "support@couplesmeal.com" 
                    };
                    
                    document.getElementById('storeName').value = settings.name;
                    document.getElementById('storeTitle').value = settings.title;
                    document.getElementById('storeLogoUrl').value = settings.logoUrl || '';
                    document.getElementById('storeAddress').value = settings.address;
                    document.getElementById('storeContact').value = settings.contact;
                    
                    // Apply settings to storefront elements
                    document.getElementById('headerStoreName').textContent = settings.name;
                    document.title = settings.title;
                    document.getElementById('footerStoreName').textContent = settings.name;
                    document.getElementById('footerYear').textContent = new Date().getFullYear();
                    
                    // Update logo if available
                    const storeLogo = document.getElementById('storeLogo');
                    if (settings.logoUrl) {
                        storeLogo.src = settings.logoUrl;
                        storeLogo.style.display = 'block';
                    } else {
                        storeLogo.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error("Error loading settings:", error);
                });
        }


        // --- CORE INITIALIZATION AND EVENT LISTENERS ---

        function initializeFirebaseApp() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                storage = firebase.storage();
                
                // 1. Initial data load for the storefront (Must run immediately)
                fetchAndRenderSettings();
                fetchAndRenderProducts(db);
                
                // 2. Setup all event listeners
                setupEventListeners();
                
                // 3. Initialize image upload functionality
                initializeImageUpload();

                // 4. Handle Auth State for both Admin and Customer views
                auth.onAuthStateChanged((user) => {
                    const adminPanel = document.getElementById('adminPanel');
                    const adminLogin = document.getElementById('loginSection');

                    if (user) {
                        // Simple check for admin: user must exist and contain 'admin' in email (or be explicitly whitelisted)
                        if (user.email.includes('admin') || user.email === 'admin@couplesmeal.com') { 
                            adminPanel.style.display = 'block';
                            adminLogin.style.display = 'none';
                            document.getElementById('authStatus').textContent = `Admin Logged in: ${user.email}`;
                            fetchAndRenderOrders(db);
                        } else {
                            // Non-admin user logged in (customer)
                            adminPanel.style.display = 'none';
                            adminLogin.style.display = 'block';
                            document.getElementById('authStatus').textContent = 'Admin Logged Out (Customer Account Active)';
                        }
                    } else {
                        // User is logged out
                        adminPanel.style.display = 'none';
                        adminLogin.style.display = 'block';
                        document.getElementById('authStatus').textContent = 'Admin Logged Out';
                    }
                    
                    renderMyAccount(); // Update customer account view
                });
                
            } catch(e) {
                console.error("Firebase initialization failed:", e);
                document.getElementById('products-container').innerHTML = `<p style="color: var(--error); text-align: center;">Fatal Error: Firebase connection failed. Check console for details.</p>`;
            }
        }

        function setupEventListeners() {
            // --- Customer Navigation ---
            document.querySelectorAll('.nav-links button').forEach(button => {
                button.addEventListener('click', (e) => navigateTo(e.currentTarget.dataset.view));
            });

            // --- Customer Checkout ---
            document.getElementById('checkoutForm').addEventListener('submit', window.placeOrder);

            // --- Customer Auth ---
            document.getElementById('customerLoginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('customerEmailAuth').value;
                const password = document.getElementById('customerPasswordAuth').value;
                
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    showNotification('Login successful!', false, 'accountNotification');
                } catch (error) {
                    showNotification(`Login failed: ${error.message}`, true, 'accountNotification');
                }
            });

            document.getElementById('signUpBtn').addEventListener('click', async () => {
                const email = document.getElementById('customerEmailAuth').value;
                const password = document.getElementById('customerPasswordAuth').value;
                
                if (!email || !password) {
                    showNotification('Please enter email and password for sign up.', true, 'accountNotification');
                    return;
                }
                
                try {
                    await auth.createUserWithEmailAndPassword(email, password);
                    showNotification('Account created successfully and logged in!', false, 'accountNotification');
                } catch (error) {
                    showNotification(`Sign up failed: ${error.message}`, true, 'accountNotification');
                }
            });


            // --- Admin Tab Navigation ---
            document.querySelectorAll('#adminPanel .tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tabName = e.target.dataset.tab;
                    setActiveAdminTab(tabName);
                    if (tabName === 'orders') fetchAndRenderOrders();
                    if (tabName === 'products') fetchAndRenderProducts(db);
                });
            });

            // --- Admin Login ---
            document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    showNotification('Admin Login successful!', false, 'authStatus');
                } catch (error) {
                    showNotification(`Admin Login failed: ${error.message}`, true, 'authStatus');
                }
            });

            // --- Admin Products Form Display ---
            document.getElementById('showAddProductForm').addEventListener('click', () => {
                document.getElementById('addProductContainer').style.display = 'block';
                document.getElementById('showAddProductForm').style.display = 'none';
                document.getElementById('saveProductForm').reset();
                document.getElementById('productIdToEdit').value = '';
                document.getElementById('productFormTitle').textContent = 'Add New Product';
                document.getElementById('productSubmitButtonText').textContent = 'Save Product';
                
                // Reset image preview and upload
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('imagePreview').src = '';
                document.getElementById('productImageUpload').value = '';
                document.getElementById('upload-btn-text').textContent = 'Click to upload an image or drag & drop';
            });

            document.getElementById('cancelEdit').addEventListener('click', () => {
                document.getElementById('addProductContainer').style.display = 'none';
                document.getElementById('showAddProductForm').style.display = 'block';
            });
            
            // --- Save/Update Product ---
            document.getElementById('saveProductForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const productId = document.getElementById('productIdToEdit').value;
                const name = document.getElementById('productName').value;
                const description = document.getElementById('productDesc').value;
                const price = parseFloat(document.getElementById('productPrice').value);
                const imageUrl = document.getElementById('productImage').value;

                if (isNaN(price)) {
                    showNotification('Price must be a valid number.', true);
                    return;
                }

                const productData = {
                    name: name,
                    description: description,
                    price: price,
                    imageUrl: imageUrl || null
                };

                const collectionRef = db.collection(COLLECTIONS.PRODUCTS);

                if (productId) {
                    // Update existing product
                    collectionRef.doc(productId).update(productData)
                    .then(() => {
                        showNotification('Product updated successfully!');
                        document.getElementById('addProductContainer').style.display = 'none';
                        document.getElementById('showAddProductForm').style.display = 'block';
                        fetchAndRenderProducts(db); 
                    })
                    .catch((error) => showNotification(`Error updating product: ${error.message}`, true));

                } else {
                    // Add new product
                    productData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    
                    collectionRef.add(productData)
                    .then(() => {
                        showNotification('Product saved successfully!');
                        document.getElementById('saveProductForm').reset();
                        fetchAndRenderProducts(db); 
                    })
                    .catch((error) => showNotification(`Error saving product: ${error.message}`, true));
                }
            });

            // --- Store Settings Save ---
            document.getElementById('storeSettingsForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const settingsData = {
                    name: document.getElementById('storeName').value,
                    title: document.getElementById('storeTitle').value,
                    logoUrl: document.getElementById('storeLogoUrl').value,
                    address: document.getElementById('storeAddress').value,
                    contact: document.getElementById('storeContact').value
                };

                db.collection(COLLECTIONS.SETTINGS).doc('store').set(settingsData)
                    .then(() => {
                        fetchAndRenderSettings();
                        showNotification('Store settings saved successfully!', false, 'settingsNotification');
                    })
                    .catch(error => showNotification(`Error saving settings: ${error.message}`, true, 'settingsNotification'));
            });
        }
        
        document.addEventListener('DOMContentLoaded', initializeFirebaseApp);
    </script>
</body>
</html>
